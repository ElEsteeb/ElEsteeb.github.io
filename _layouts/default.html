<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>{{ page.title }} | {{ site.title }}</title>
  <link rel="stylesheet" href="{{ '/styles.css' | relative_url }}?v=1.1">

  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="{{ page.title | default: site.title }}">
  <meta property="og:description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
  <meta property="og:url" content="{{ page.url | absolute_url }}">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="{{ site.title }}">
  {% if page.image %}
    <meta property="og:image" content="{{ page.image | absolute_url }}">
  {% else %}
    <meta property="og:image" content="{{ '/assets/images/default-image.jpg' | absolute_url }}">
  {% endif %}

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ page.title | default: site.title }}">
  <meta name="twitter:description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
  {% if page.image %}
    <meta name="twitter:image" content="{{ page.image | absolute_url }}">
  {% else %}
    <meta name="twitter:image" content="{{ '/assets/images/default-image.jpg' | absolute_url }}">
  {% endif %}

  
</head>

<body>
  <nav>
    <div class="menu-toggle">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
    <div class="nav-links">
      <a href="/" {% if page.url == '/' %}style="color: red;"{% endif %}>Home</a>
      <a href="/devotional.html" {% if page.url == '/devotional.html' %}style="color: red;"{% endif %}>Devotional</a>
      <a href="/notes.html" {% if page.url == '/notes.html' %}style="color: red;"{% endif %}>Class Notes</a>
      <a href="/class_recordings.html" {% if page.url == '/class_recordings.html' %}style="color: red;"{% endif %}>Class Recordings</a>
      <div class="search-container">
        <input type="text" id="search-input" placeholder="Search...">
      </div>
    </div>
  </nav>
  <div id="search-results"></div>
  
  <div class="post-container">
    {{ content }}
    {% include social-share.html %}
  </div>

  <!-- Dark mode toggle button -->
  <button class="dark-mode-toggle">ðŸŒ“</button>

  <!-- RefTagger Script -->
  <script src="https://api.reftagger.com/v2/RefTagger.js" async></script>
  <script>
    window.refTagger = {
      settings: {
        bibleVersion: "ESV",
        addLogosLink: true,
        linksOpenNewWindow: true,
        socialSharing: ["twitter", "facebook"],
        tagChapters: true
      }
    };
  </script>

  <!-- Lunr.js for search -->
  <script src="https://unpkg.com/lunr/lunr.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch the search index
      fetch('{{ "/search-index.json" | relative_url }}')
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to fetch search index: ${response.status} ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          // Initialize Lunr.js
          const idx = lunr(function() {
            this.ref('url');
            this.field('title', { boost: 10 });
            this.field('content');
            data.forEach(doc => this.add(doc));
          });

          // Search functionality
          const searchInput = document.getElementById('search-input');
          const searchResults = document.getElementById('search-results');

          function positionSearchResults() {
            const inputRect = searchInput.getBoundingClientRect();
            const scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
            const scrollX = window.scrollX || window.pageXOffset || document.documentElement.scrollLeft;
            searchResults.style.top = `${inputRect.bottom + scrollY + 5}px`;
            searchResults.style.left = `${inputRect.left + scrollX}px`;
            if (window.innerWidth > 767) {
              searchResults.style.width = '300px';
            } else {
              searchResults.style.width = `${inputRect.width}px`;
            }
          }

          searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            if (query.length < 2) {
              searchResults.innerHTML = '';
              searchResults.classList.remove('active');
              return;
            }
            const results = idx.search(query + '*');
            if (results.length === 0) {
              searchResults.innerHTML = '<div class="search-result">No results found.</div>';
            } else {
              searchResults.innerHTML = results.map(result => {
                const item = data.find(doc => doc.url === result.ref);
                return `<div class="search-result"><a href="${item.url}">${item.title}</a></div>`;
              }).join('');
            }
            positionSearchResults();
            searchResults.classList.add('active');
          });

          // Reposition on window resize or scroll
          window.addEventListener('resize', positionSearchResults);
          window.addEventListener('scroll', positionSearchResults);

          // Hide results when clicking outside
          document.addEventListener('click', function(event) {
            if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
              searchResults.classList.remove('active');
            }
          });
        })
        .catch(error => {
          console.error('Error loading search index:', error);
          const searchResults = document.getElementById('search-results');
          if (searchResults) {
            searchResults.innerHTML = '<div class="search-result">Error loading search index. Please try again later.</div>';
            searchResults.classList.add('active');
            positionSearchResults();
          }
        });
    });
  </script>

  <!-- Load main.js for menu toggle -->
  <script src="{{ '/assets/js/main.js' | relative_url }}?v=1.1" defer></script>

  <!-- Dark mode toggle script -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const darkModeToggle = document.querySelector('.dark-mode-toggle');
    if (darkModeToggle) {
      const toggleDarkMode = () => {
        console.log('Toggling dark mode'); // Debug log
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
      };
      darkModeToggle.addEventListener('click', toggleDarkMode);
      darkModeToggle.addEventListener('touchstart', toggleDarkMode);
    }

    // Load dark mode preference on page load
    if (localStorage.getItem('darkMode') === 'enabled') {
      document.body.classList.add('dark-mode');
    }
  });
  </script>
</body>
</html>
